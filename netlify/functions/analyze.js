const axios = require('axios');

exports.handler = async function(event, context) {
    const headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'POST, OPTIONS'
    };

    if (event.httpMethod === 'OPTIONS') {
        return {
            statusCode: 200,
            headers,
            body: ''
        };
    }

    if (event.httpMethod !== 'POST') {
        return {
            statusCode: 405,
            headers,
            body: JSON.stringify({ error: 'Method not allowed' })
        };
    }

    try {
        const { answers } = JSON.parse(event.body);
        const apiKey = process.env.DEEPSEEK_API_KEY;
        
        if (!apiKey) {
            throw new Error('API key not configured');
        }

        const prompt = createPrompt(answers);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º OpenRouter –≤–º–µ—Å—Ç–æ DeepSeek
        const response = await axios.post('https://openrouter.ai/api/v1/chat/completions', {
            model: "google/gemini-flash-1.5", // –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å
            messages: [
                {
                    role: "system",
                    content: `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. 
                    –¢—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–µ, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏.
                    –£—á—Ç–∏ –≤—Å–µ –Ω—é–∞–Ω—Å—ã –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã.
                    
                    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
                    1. –ê–Ω–∞–ª–∏–∑ –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç–µ–π (–Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤)
                    2. 3-5 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–π —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ø–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥—è—Ç
                    3. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è
                    4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é
                    
                    –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤!`
                },
                {
                    role: "user",
                    content: prompt
                }
            ],
            max_tokens: 2000,
            temperature: 0.7
        }, {
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': 'https://your-site.netlify.app', // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL
                'X-Title': 'Profession Test'
            }
        });

        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                analysis: response.data.choices[0].message.content
            })
        };

    } catch (error) {
        console.error('Error:', error.response?.data || error.message);
        
        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                success: true,
                analysis: generateFallbackAnalysis()
            })
        };
    }
};

function createPrompt(answers) {
    let prompt = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏:\n\n";
    
    const questionThemes = [
        "–õ—é–±–∏–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
        "–•–æ–±–±–∏ –∏ —É–≤–ª–µ—á–µ–Ω–∏—è", 
        "–£–≤–ª–µ–∫–∞—é—â–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
        "–†–∞–±–æ—á–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è",
        "–û–ø—ã—Ç —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º",
        "–ù–∞–≤—ã–∫–∏ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏",
        "–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ä—É—Ç–∏–Ω–µ",
        "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏",
        "–ò–¥–µ–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å",
        "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è",
        "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è",
        "–°—Ç–∏–ª—å –æ–±—É—á–µ–Ω–∏—è",
        "–°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã",
        "–ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ"
    ];

    answers.forEach((answer, index) => {
        if (answer && answer.trim() !== '') {
            prompt += `${questionThemes[index]}: ${answer}\n\n`;
        }
    });

    prompt += "–î–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!";
    return prompt;
}

function generateFallbackAnalysis() {
    return `–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ —è –ø—Ä–æ–≤–µ–ª –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç–µ–π –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤. –í–æ—Ç –º–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

üéØ **–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

1. **–ú–µ–∂–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏** - —É—á–∏—Ç—ã–≤–∞—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
2. **–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ —Å –≥–∏–±–∫–∏–º –≥—Ä–∞—Ñ–∏–∫–æ–º** - –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –≤ —Ä–∞–±–æ—Ç–µ
3. **–°—Ñ–µ—Ä—ã —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º —Ä–∞–∑–≤–∏—Ç–∏–µ–º** - —á—Ç–æ–±—ã —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å –≤–∞—à—É –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

üí° **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è:**
- –ü—Ä–æ–π–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∏–∑ 5-7 –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–π
- –ò–∑—É—á–∏—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ä—ã–Ω–∫–∞ —Ç—Ä—É–¥–∞ –∫ —ç—Ç–∏–º –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –∫—É—Ä—Å—ã –∏–ª–∏ –≤–æ—Ä–∫—à–æ–ø—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ñ–µ—Ä–∞—Ö

üìö **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é:**
- –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç–∞ —Å —à–∏—Ä–æ–∫–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º
- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–≤–æ–π–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π
- –ò–∑—É—á–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ã –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö —Ç–∏–ø–∞ Coursera, Stepik

üåü **–í–∞–∂–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:**
- –ù–µ –±–æ–π—Ç–µ—Å—å –ø—Ä–æ–±–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –û–±—â–∞–π—Ç–µ—Å—å —Å –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ –∏–∑ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏—Ö —Å—Ñ–µ—Ä
- –£—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞—Ö –∏ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
- –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—É—Ç—å –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!

–í–∞—à–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö. –ì–ª–∞–≤–Ω–æ–µ - –Ω–∞—á–∞—Ç—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å!`;
}
    prompt += "–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤!";

    return prompt;
}
